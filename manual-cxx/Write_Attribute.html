<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">

  <head>
    <title>Stencil Test/Write Attribute - Panda3D Manual</title>
    <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<link rel="stylesheet" href="style.css" type="text/css"><link rel="shortcut icon" href="favicon.ico">    <meta name="keywords" content="Panda3D, Panda, 3D, Python, graphics, free, game, engine, game rendering engine, simulation, open source, free download, Disney, ETC, Entertainment Technology Center, open-source">
    <meta name="description" content="Free open source 3D game and simulation engine developed by Disney and maintained by Carnegie Mellon University\'s Entertainment Technology Center">
    </head>
    <body>
<table width=960 cellpadding=0 cellspacing=0 id=main align=center>
<tr>
<td id=borderleft></td>
<td id=maincenter valign=top>
<tr><td id=pcontent valign=top><h2>Panda3D Manual: Stencil Test/Write Attribute</h2>
<div style="width:100%; padding: 1px;" class=subnavigation>
<table width="640px" cellpadding="0" cellspacing="0" border="0">
              <tr>
              <td width="70px" align="left">&nbsp;&nbsp;<a style="text-decoration:none" href="Auxiliary_Bitplane_Control.html"><img border=0 width=16 height=16 src="arrow_left.png" align=absmiddle> <u>Prev</u></a></td>
              <td width="70px" align="center"><a style="text-decoration:none" href="Main_Page.html"><img border=0 width=16 height=16 src="arrow_up.png" align=absmiddle><u>Top</u></a></td>
              <td width="70px" align="right"><a style="text-decoration:none" href="Texturing.html"><u>Next</u> <img border=0 width=16 height=16 src="arrow_right.png" align=absmiddle></a>&nbsp;&nbsp;</td>
              </tr></table></div><div class='wikicontent' id='wikicontentid'><p>The StencilAttrib is used for testing and writing to the stencil buffer.  Note that both of these actions can be performed simultaneously with a single StencilAttrib.</p>
<p>The stencil buffer is an ancillary graphics buffer, in addition to the more well-known color and depth buffers.  It provides a per-pixel mask for the rendering pipeline which can be exploited to selectively render objects or parts of objects.  Typical applications of the stencil buffer include binary masking, shadowing and planar reflections.</p>
<p>Usually, using the stencil buffer involves creating some objects which are not rendered into the color buffer.  Their contribution to the rendered scene is to provide an invisible boundary that can be used to turn color buffer rendering on and off for other objects in the scene.  Think of it as a cardboard cut-out through which the world is viewed.</p>
<p>During a stencil comparison, the StencilAttrib's reference value is compared against the value stored in the stencil buffer.  The order matters here.  For example, consider comparison function StencilAttrib.SCFGreaterThan with reference value r=1.  A pixel passes the stencil test if r &gt; S<sub>p</sub>, where S<sub>p</sub> is the value in the stencil buffer at pixel <i>p</i>.  Objects contributing values to the stencil buffer that will be read by other StencilAttributes' comparison functions must be rendered first, or unexpected results will occur.  See <a href="How_to_Control_Render_Order.html" title="How to Control Render Order">How to Control Render Order</a>.</p>
<p>The stencil buffer is disabled by default.  In order to use StencilAttribs, you must add the following line to your config.prc file:</p>
<pre class="codeblock">
framebuffer-stencil #t
</pre>
<p>StencilAttribs are defined exclusively by their constructor functions, so let's examine one to understand what each part does.  The following code creates an attribute which tells an object to render only if the stencil buffer is exactly 1, and does not itself modify the stencil buffer.</p>
<pre class="python">stencilReader =<br />  StencilAttrib.<span style="color: black;">make</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">1</span>,StencilAttrib.<span style="color: black;">SCFEqual</span>,StencilAttrib.<span style="color: black;">SOKeep</span>,<br />                       StencilAttrib.<span style="color: black;">SOKeep</span>,StencilAttrib.<span style="color: black;">SOKeep</span>,<span style="color: #ff4500;">1</span>,<span style="color: #ff4500;">1</span>,<span style="color: #ff4500;">0</span><span style="color: black;">&#41;</span></pre>
<p>The first parameter is a boolean.  If this parameter is zero, the StencilAttrib is not processed.  Next is the comparison function this attribute uses, in this case Equal.  The next three parameters determine what happens to the stencil buffer depending on the result of the comparison.  We'll get to these in a minute.  The three Keep values tell this attribute never to modify the values in the buffer.  Next is the reference value for the comparison function.  Before the reference value is passed to the comparison function, however, it is bitwise ANDed with a mask.  In our case, we're interested in reading but not in writing the stencil buffer, so we pass 1 and 0 for the read and write masks, respectively.  These masks are the last two parameters for the StencilAttrib.</p>
<p>Next, we'll look at a stencil attribute that writes the stencil buffer.  Presumably, these two functions will work in tandem to create an effect.</p>
<pre class="python">constantOneStencil =<br />  StencilAttrib.<span style="color: black;">make</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">1</span>,StencilAttrib.<span style="color: black;">SCFAlways</span>,StencilAttrib.<span style="color: black;">SOZero</span>,<br />                       StencilAttrib.<span style="color: black;">SOReplace</span>,StencilAttrib.<span style="color: black;">SOReplace</span>,<span style="color: #ff4500;">1</span>,<span style="color: #ff4500;">0</span>,<span style="color: #ff4500;">1</span><span style="color: black;">&#41;</span></pre>
<p>Again we start by enabling the attribute.  The comparison function here is Always, meaning that the test passes no matter the parameters.  Next is the operation to perform on the stencil buffer if the test fails (which in this case will never happen) -- we set the stencil buffer value to zero.  The next parameter determines what should happen if the stencil function passes, but the depth test fails, and finally, what should happen if both the stencil and depth tests pass.  In our case we want to set the value of the stencil buffer whether we pass the depth test or not, so both are set to Replace.  The reference value to set in the stencil buffer is 1.  We're writing regardless of what's in the buffer already, so we'll set the read and write masks to 0 and 1, respectively.</p>
<p>Now we can add these attributes to nodes in the scene to exploit the effect. Here is the entire script.</p>
<pre class="python"><span style="color: #ff7700;font-weight:bold;">from</span> panda3d.<span style="color: black;">core</span> <span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #66cc66;">*</span><br />&#160;<br /><span style="color: #808080; font-style: italic;"># Do this before the next import:</span><br />loadPrcFileData<span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;&quot;</span>, <span style="color: #483d8b;">&quot;framebuffer-stencil #t&quot;</span><span style="color: black;">&#41;</span><br />&#160;<br /><span style="color: #ff7700;font-weight:bold;">import</span> direct.<span style="color: black;">directbase</span>.<span style="color: black;">DirectStart</span><br />&#160;<br />constantOneStencil = StencilAttrib.<span style="color: black;">make</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">1</span>,StencilAttrib.<span style="color: black;">SCFAlways</span>,<br />StencilAttrib.<span style="color: black;">SOZero</span>,StencilAttrib.<span style="color: black;">SOReplace</span>,<br />StencilAttrib.<span style="color: black;">SOReplace</span>,<span style="color: #ff4500;">1</span>,<span style="color: #ff4500;">0</span>,<span style="color: #ff4500;">1</span><span style="color: black;">&#41;</span><br />&#160;<br />stencilReader = StencilAttrib.<span style="color: black;">make</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">1</span>,StencilAttrib.<span style="color: black;">SCFEqual</span>,<br />StencilAttrib.<span style="color: black;">SOKeep</span>, StencilAttrib.<span style="color: black;">SOKeep</span>,<br />StencilAttrib.<span style="color: black;">SOKeep</span>,<span style="color: #ff4500;">1</span>,<span style="color: #ff4500;">1</span>,<span style="color: #ff4500;">0</span><span style="color: black;">&#41;</span> <br />&#160;<br />cm = CardMaker<span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;cardmaker&quot;</span><span style="color: black;">&#41;</span><br />cm.<span style="color: black;">setFrame</span><span style="color: black;">&#40;</span>-.<span style="color: #ff4500;">5</span>,.<span style="color: #ff4500;">5</span>,-.<span style="color: #ff4500;">5</span>,.<span style="color: #ff4500;">5</span><span style="color: black;">&#41;</span><br />&#160;<br /><span style="color: #808080; font-style: italic;"># To rotate the card to face the camera, we create</span><br /><span style="color: #808080; font-style: italic;"># it and then parent it to the camera.</span><br />viewingSquare = render.<span style="color: black;">attachNewNode</span><span style="color: black;">&#40;</span>cm.<span style="color: black;">generate</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><br />viewingSquare.<span style="color: black;">reparentTo</span><span style="color: black;">&#40;</span>base.<span style="color: black;">camera</span><span style="color: black;">&#41;</span><br />viewingSquare.<span style="color: black;">setPos</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">0</span>, <span style="color: #ff4500;">5</span>, <span style="color: #ff4500;">0</span><span style="color: black;">&#41;</span> <br />&#160;<br />viewingSquare.<span style="color: black;">node</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>.<span style="color: black;">setAttrib</span><span style="color: black;">&#40;</span>constantOneStencil<span style="color: black;">&#41;</span><br />viewingSquare.<span style="color: black;">node</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>.<span style="color: black;">setAttrib</span><span style="color: black;">&#40;</span>ColorWriteAttrib.<span style="color: black;">make</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">0</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><br />viewingSquare.<span style="color: black;">setBin</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'background'</span>,<span style="color: #ff4500;">0</span><span style="color: black;">&#41;</span><br />viewingSquare.<span style="color: black;">setDepthWrite</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">0</span><span style="color: black;">&#41;</span><br />&#160;<br />view = loader.<span style="color: black;">loadModel</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;panda&quot;</span><span style="color: black;">&#41;</span><br />view.<span style="color: black;">reparentTo</span><span style="color: black;">&#40;</span>render<span style="color: black;">&#41;</span><br />view.<span style="color: black;">setScale</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">3</span><span style="color: black;">&#41;</span><br />view.<span style="color: black;">setY</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">150</span><span style="color: black;">&#41;</span><br />view.<span style="color: black;">node</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>.<span style="color: black;">setAttrib</span><span style="color: black;">&#40;</span>stencilReader<span style="color: black;">&#41;</span><br />&#160;<br />run<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span></pre>
<p>You can get a little more insight into stencils in this thread on the forums: <a rel="nofollow" class="external free" href="http://www.panda3d.org/phpbb2/viewtopic.php?p=48451#48451">http://www.panda3d.org/phpbb2/viewtopic.php?p=48451#48451</a></p>

<!-- 
NewPP limit report
Preprocessor node count: 13/1000000
Post-expand include size: 0/2097152 bytes
Template argument size: 0/2097152 bytes
Expensive parser function count: 0/100
-->

<!-- Saved in parser cache with key mw_manual:pcache:idhash:2098-0!*!0!*!*!*!* and timestamp 20130413213529 -->
</div><div style="width:100%; padding: 1px;" class=subnavigation>
<table width="640px" cellpadding="0" cellspacing="0" border="0">
              <tr>
              <td width="70px" align="left">&nbsp;&nbsp;<a style="text-decoration:none" href="Auxiliary_Bitplane_Control.html"><img border=0 width=16 height=16 src="arrow_left.png" align=absmiddle> <u>Prev</u></a></td>
              <td width="70px" align="center"><a style="text-decoration:none" href="Main_Page.html"><img border=0 width=16 height=16 src="arrow_up.png" align=absmiddle><u>Top</u></a></td>
              <td width="70px" align="right"><a style="text-decoration:none" href="Texturing.html"><u>Next</u> <img border=0 width=16 height=16 src="arrow_right.png" align=absmiddle></a>&nbsp;&nbsp;</td>
              </tr></table></div><div id=legal>&copy; Carnegie Mellon University 2010</div></td></tr></table></td><td id=borderright></td></tr></table></td><td id=borderright></td></tr></table></body></html>